<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh s√°ch l·ªùi ch√∫c</title>
  <link rel="stylesheet" href="styles_list.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 70px 10px 10px; /* ch·ª´a kho·∫£ng tr·ªëng cho filter fixed */
      background-color: #fff0f5;
      margin: 0;
    }
    h2 {
      text-align: center;
      color: #d63384;
      margin-top: 0;
    }
    #filterContainer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #ffe6ef;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 999;
      text-align: center;
    }
    #filterContainer input {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .message-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      margin: 5px 5px 5px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #ffb3d1;
      color: #000;
      cursor: pointer;
    }
    .media-container {
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    video, audio {
      width: 100%;
      max-width: 100%;
      max-height: 280px;
    }
    .timestamp {
      font-size: 0.85em;
      color: #666;
      margin-top: 8px;
    }
    .contact-link {
  display: inline-block;
  word-break: break-all;
  max-width: 100%;
  color: #333;
  font-weight: 500;
}

button {
  margin: 5px 5px 5px 0;
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  background-color: #ffb3d1;
  color: #000;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  background-color: #ff80bf;
  transform: scale(1.05);
}


    @media (max-width: 600px) {
      button {
        width: 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <h2>üíå Danh s√°ch l·ªùi ch√∫c</h2>
  <div id="filterContainer">
    üìÖ L·ªçc theo ng√†y: <input type="date" id="dateFilter">
  </div>
  <div id="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
  <ul id="messageList"></ul>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCR6ChodbxTFeMqVEfc37LGMZn0sRKyl-k",
      authDomain: "loichucyeuthuong18.firebaseapp.com",
      projectId: "loichucyeuthuong18",
      storageBucket: "loichucyeuthuong18.firebasestorage.app",
      messagingSenderId: "434140825017",
      appId: "1:434140825017:web:13deda5e05e22fe2f76268"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const messageList = document.getElementById("messageList");
    const loading = document.getElementById("loading");
    const dateFilter = document.getElementById("dateFilter");

    function renderMessages(snapshot) {
      messageList.innerHTML = "";
      loading.style.display = "none";

      let count = 0;

      snapshot.forEach(child => {
        const data = child.val();

        if (dateFilter.value) {
          const selectedDate = new Date(dateFilter.value);
          const msgDate = new Date(data.timestamp);
          if (msgDate.toDateString() !== selectedDate.toDateString()) return;
        }

        count++;

        const li = document.createElement("li");
        li.className = "message-item";

        let fileButtonsHTML = "";
        if (Array.isArray(data.files)) {
          data.files.forEach((fileUrl, idx) => {
            const fileType = fileUrl.includes(".mp4") || fileUrl.includes("video") ? "video" :
                             fileUrl.includes(".mp3") || fileUrl.includes("audio") ? "audio" : "other";
            fileButtonsHTML += `<button onclick="showFile(this, '${fileUrl}', '${fileType}')">üìé File ${idx + 1}</button>`;
          });
        }

        li.innerHTML = `
          <b>STT ${count}:</b> <b>${data.sender}</b> g·ª≠i ƒë·∫øn <b>${data.receiver}</b><br>
          <i>Li√™n h·ªá:</i> <span class="contact-link">${data.contact}</span>
          <button onclick="copyToClipboard('${data.contact}', this)">üìã Copy</button><br><br>

          <button onclick="showMessage(this, \`${escapeHtml(data.message)}\`)">üì® Xem l·ªùi nh·∫Øn</button>
          ${fileButtonsHTML}
          <div class="media-container"></div>
          <div class="timestamp">üïí ${new Date(data.timestamp).toLocaleString()}</div>
        `;

        messageList.appendChild(li);
      });
    }

    db.ref("messages").on("value", snapshot => renderMessages(snapshot), error => {
      loading.textContent = "‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu.";
      console.error("Firebase load error:", error);
    });

    dateFilter.addEventListener("change", () => {
      db.ref("messages").once("value").then(renderMessages);
    });

    function showFile(button, url, type) {
      const container = button.parentElement.querySelector(".media-container");
      container.innerHTML = "";

      let media;
       if (type === "video") {
    media = document.createElement("video");
    media.src = url;
    media.controls = true;
  } else if (type === "audio") {
    media = document.createElement("audio");
    media.src = url;
    media.controls = true;
  } else if (url.match(/\.(jpeg|jpg|png|gif)$/i)) {
    media = document.createElement("img");
    media.src = url;
    media.style.maxWidth = "100%";
    media.style.borderRadius = "8px";
  } else {
    media = document.createElement("a");
    media.href = url;
    media.textContent = "üì• T·∫£i file";
    media.target = "_blank";
  }

      media.style.display = "block";
      media.style.marginTop = "10px";
      container.appendChild(media);

// Th√™m n√∫t t·∫£i xu·ªëng n·∫øu kh√¥ng ph·∫£i l√† th·∫ª <a> (v√¨ <a> ƒë√£ l√† link t·∫£i)
if (type === "video" || type === "audio" || media.tagName === "IMG") {
  const downloadBtn = document.createElement("button");
  downloadBtn.textContent = "‚¨áÔ∏è T·∫£i xu·ªëng";
  downloadBtn.onclick = async () => {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      const blobUrl = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = `file-${Date.now()}`;
      a.click();
      URL.revokeObjectURL(blobUrl);
    } catch (err) {
      alert("‚ùå Kh√¥ng th·ªÉ t·∫£i file.");
      console.error(err);
    }
  };
  container.appendChild(downloadBtn);
}


    }

    function showMessage(button, msg) {
      const container = button.parentElement.querySelector(".media-container");
      container.innerHTML = "";

      const messageDiv = document.createElement("div");
      messageDiv.style.marginTop = "10px";
      messageDiv.style.padding = "10px";
      messageDiv.style.backgroundColor = "#fff0f5";
      messageDiv.style.border = "1px solid #d63384";
      messageDiv.style.borderRadius = "8px";
      messageDiv.textContent = msg;

      container.appendChild(messageDiv);
    }

    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;")
                 .replace(/\n/g, "\\n");
    }
   
    function copyToClipboard(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    // Thay ƒë·ªïi m√†u v√† n·ªôi dung n√∫t
    const originalText = button.textContent;
    button.textContent = "‚úÖ ƒê√£ sao ch√©p";
    button.style.backgroundColor = "#d63384";
    button.style.color = "white";
    button.style.transition = "all 0.3s ease";

    // Tr·ªü l·∫°i b√¨nh th∆∞·ªùng sau 2 gi√¢y
    setTimeout(() => {
      button.textContent = originalText;
      button.style.backgroundColor = "#ffb3d1";
      button.style.color = "#000";
    }, 2000);
  }).catch(err => {
    console.error(err);
  });
}


  </script>
</body>
</html>
